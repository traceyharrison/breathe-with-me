<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Box Breathing - Calm Your Mind</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', sans-serif;
            background: #0a0520;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #ffffff;
            overflow-x: hidden;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(ellipse at 20% 20%, rgba(99, 102, 241, 0.15) 0%, transparent 50%),
                        radial-gradient(ellipse at 80% 80%, rgba(139, 92, 246, 0.15) 0%, transparent 50%),
                        radial-gradient(ellipse at 50% 50%, rgba(59, 130, 246, 0.1) 0%, transparent 70%);
            z-index: 0;
        }

        /* Animated stars - more filled background with enhanced twinkling */
        body::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(2px 2px at 10% 20%, white, transparent),
                radial-gradient(2px 2px at 20% 30%, white, transparent),
                radial-gradient(2px 2px at 15% 45%, white, transparent),
                radial-gradient(1px 1px at 25% 15%, white, transparent),
                radial-gradient(2px 2px at 30% 60%, white, transparent),
                radial-gradient(1px 1px at 35% 35%, white, transparent),
                radial-gradient(2px 2px at 40% 75%, white, transparent),
                radial-gradient(1px 1px at 45% 50%, white, transparent),
                radial-gradient(2px 2px at 50% 10%, white, transparent),
                radial-gradient(1px 1px at 50% 50%, white, transparent),
                radial-gradient(2px 2px at 55% 85%, white, transparent),
                radial-gradient(1px 1px at 60% 25%, white, transparent),
                radial-gradient(2px 2px at 60% 70%, white, transparent),
                radial-gradient(1px 1px at 65% 45%, white, transparent),
                radial-gradient(2px 2px at 70% 55%, white, transparent),
                radial-gradient(1px 1px at 70% 35%, white, transparent),
                radial-gradient(2px 2px at 75% 20%, white, transparent),
                radial-gradient(1px 1px at 80% 10%, white, transparent),
                radial-gradient(2px 2px at 80% 65%, white, transparent),
                radial-gradient(1px 1px at 85% 40%, white, transparent),
                radial-gradient(2px 2px at 90% 60%, white, transparent),
                radial-gradient(1px 1px at 90% 80%, white, transparent),
                radial-gradient(2px 2px at 95% 30%, white, transparent),
                radial-gradient(1px 1px at 33% 80%, white, transparent),
                radial-gradient(1px 1px at 15% 75%, white, transparent),
                radial-gradient(1px 1px at 22% 55%, white, transparent),
                radial-gradient(1px 1px at 38% 92%, white, transparent),
                radial-gradient(1px 1px at 42% 5%, white, transparent),
                radial-gradient(1px 1px at 58% 68%, white, transparent),
                radial-gradient(1px 1px at 72% 88%, white, transparent),
                radial-gradient(1px 1px at 88% 15%, white, transparent),
                radial-gradient(1px 1px at 92% 45%, white, transparent),
                radial-gradient(1px 1px at 5% 60%, white, transparent),
                radial-gradient(1px 1px at 12% 10%, white, transparent),
                radial-gradient(1px 1px at 28% 38%, white, transparent),
                radial-gradient(1px 1px at 48% 82%, white, transparent),
                radial-gradient(1px 1px at 62% 58%, white, transparent),
                radial-gradient(1px 1px at 78% 72%, white, transparent),
                radial-gradient(1px 1px at 8% 35%, white, transparent),
                radial-gradient(1px 1px at 18% 65%, white, transparent),
                radial-gradient(2px 2px at 13% 52%, white, transparent),
                radial-gradient(1px 1px at 27% 88%, white, transparent),
                radial-gradient(2px 2px at 32% 12%, white, transparent),
                radial-gradient(1px 1px at 44% 28%, white, transparent),
                radial-gradient(2px 2px at 52% 95%, white, transparent),
                radial-gradient(1px 1px at 67% 18%, white, transparent),
                radial-gradient(2px 2px at 73% 42%, white, transparent),
                radial-gradient(1px 1px at 83% 78%, white, transparent),
                radial-gradient(2px 2px at 94% 52%, white, transparent),
                radial-gradient(1px 1px at 6% 22%, white, transparent),
                radial-gradient(2px 2px at 17% 38%, white, transparent),
                radial-gradient(1px 1px at 24% 72%, white, transparent),
                radial-gradient(2px 2px at 36% 48%, white, transparent),
                radial-gradient(1px 1px at 54% 33%, white, transparent),
                radial-gradient(2px 2px at 64% 82%, white, transparent),
                radial-gradient(1px 1px at 76% 8%, white, transparent),
                radial-gradient(2px 2px at 86% 62%, white, transparent),
                radial-gradient(1px 1px at 97% 15%, white, transparent);
            background-size: 100% 100%;
            background-position: 0% 0%;
            animation: twinkleStars 3s ease-in-out infinite;
            opacity: 0.8;
            z-index: 0;
            pointer-events: none;
        }

        @keyframes twinkleStars {
            0% { opacity: 0.8; }
            25% { opacity: 0.4; }
            50% { opacity: 0.9; }
            75% { opacity: 0.5; }
            100% { opacity: 0.8; }
        }

        .container {
            text-align: center;
            padding: 20px;
            position: relative;
            z-index: 1;
            max-width: 900px;
        }

        .settings-icon {
            position: fixed;
            top: 24px;
            right: 24px;
            padding: 12px 20px;
            border-radius: 50px;
            background: rgba(99, 102, 241, 0.15);
            border: 1px solid rgba(139, 92, 246, 0.3);
            backdrop-filter: blur(20px);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
            z-index: 1000;
            color: white;
            box-shadow: 0 4px 20px rgba(99, 102, 241, 0.2);
        }

        .settings-icon:hover {
            background: rgba(99, 102, 241, 0.25);
            border-color: rgba(139, 92, 246, 0.5);
            box-shadow: 0 6px 30px rgba(99, 102, 241, 0.4);
        }

        .settings-label {
            font-size: 0.9em;
            font-weight: 500;
            letter-spacing: 0.3px;
        }

        .settings-menu {
            position: fixed;
            top: 84px;
            right: 24px;
            width: 320px;
            background: rgba(10, 5, 32, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            border: 1px solid rgba(139, 92, 246, 0.3);
            box-shadow: 0 8px 32px rgba(99, 102, 241, 0.3);
            opacity: 0;
            transform: translateY(-10px);
            pointer-events: none;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 999;
        }

        .settings-menu.active {
            opacity: 1;
            transform: translateY(0);
            pointer-events: all;
        }

        .settings-menu-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px 16px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        }

        .settings-menu-header h3 {
            font-size: 1.1em;
            font-weight: 500;
            margin: 0;
        }

        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 2em;
            line-height: 1;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            transition: all 0.2s;
            opacity: 0.6;
        }

        .close-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            opacity: 1;
        }

        .settings-menu-content {
            padding: 20px 24px;
        }

        .music-selection {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid rgba(255, 255, 255, 0.08);
        }

        .selection-label {
            display: block;
            font-size: 0.9em;
            opacity: 0.7;
            margin-bottom: 8px;
        }

        select {
            width: 100%;
            padding: 10px 14px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            color: white;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.3s;
            outline: none;
        }

        select:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(255, 255, 255, 0.2);
        }

        select:focus {
            border-color: rgba(167, 139, 250, 0.5);
        }

        select option {
            background: #0a0520;
            color: white;
        }

        h1 {
            font-size: 2.2em;
            margin-bottom: 8px;
            font-weight: 600;
            letter-spacing: -0.5px;
            background: linear-gradient(135deg, #a78bfa 0%, #60a5fa 50%, #c084fc 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            font-size: 0.95em;
            margin-bottom: 35px;
            opacity: 0.6;
            font-weight: 400;
            letter-spacing: 0.3px;
        }

        .settings {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 18px 24px;
            margin: 0 auto 30px;
            max-width: 600px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .audio-settings {
            margin-bottom: 40px;
        }

        .audio-controls {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .toggle-group {
            display: flex;
            align-items: center;
            margin-bottom: 16px;
        }

        .toggle-group:last-of-type {
            margin-bottom: 0;
        }

        .toggle-label {
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            user-select: none;
            width: 100%;
        }

        .toggle-label input[type="checkbox"] {
            display: none;
        }

        .toggle-slider {
            position: relative;
            width: 44px;
            height: 24px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            transition: all 0.3s;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .toggle-slider::before {
            content: '';
            position: absolute;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.5);
            top: 2px;
            left: 3px;
            transition: all 0.3s;
        }

        .toggle-label input[type="checkbox"]:checked + .toggle-slider {
            background: linear-gradient(135deg, #8b5cf6 0%, #a78bfa 100%);
            border-color: transparent;
        }

        .toggle-label input[type="checkbox"]:checked + .toggle-slider::before {
            left: 21px;
            background: white;
        }

        .toggle-text {
            font-size: 0.9em;
            opacity: 0.8;
            font-weight: 400;
        }

        .settings h3 {
            margin-bottom: 12px;
            font-size: 0.85em;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            opacity: 0.7;
        }

        .preset-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 8px;
            margin-bottom: 8px;
        }

        .custom-button-row {
            display: flex;
            justify-content: center;
            margin-top: 8px;
        }

        .custom-button-row .preset-btn {
            min-width: 120px;
        }

        .preset-btn {
            padding: 9px 16px;
            font-size: 0.85em;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.05);
            color: rgba(255, 255, 255, 0.8);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 500;
            letter-spacing: 0.3px;
        }

        .preset-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
            color: white;
        }

        .preset-btn.active {
            background: linear-gradient(135deg, #8b5cf6 0%, #a78bfa 100%);
            border-color: transparent;
            color: white;
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);
        }

        .custom-controls {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid rgba(255, 255, 255, 0.08);
        }

        .slider-group {
            margin-bottom: 14px;
            text-align: left;
        }

        .slider-group label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
            font-size: 0.85em;
            opacity: 0.8;
            font-weight: 400;
        }

        .slider-group input[type="range"] {
            width: 100%;
            height: 4px;
            border-radius: 2px;
            background: rgba(255, 255, 255, 0.1);
            outline: none;
            -webkit-appearance: none;
        }

        .slider-group input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: linear-gradient(135deg, #a78bfa 0%, #c084fc 100%);
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(167, 139, 250, 0.5);
            transition: all 0.2s;
        }

        .slider-group input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.2);
        }

        .slider-group input[type="range"]::-moz-range-thumb {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: linear-gradient(135deg, #a78bfa 0%, #c084fc 100%);
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 8px rgba(167, 139, 250, 0.5);
        }

        .breathing-box {
            width: 550px;
            height: 550px;
            margin: 0 auto 50px;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .box {
            width: 350px;
            height: 350px;
            border: none;
            border-radius: 50%;
            position: absolute;
            /* Transition duration is set dynamically via JavaScript */
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            filter: blur(8px);
        }

        .box.breathe-in {
            width: 500px;
            height: 500px;
            background: linear-gradient(135deg, rgba(167, 139, 250, 0.4) 0%, rgba(139, 92, 246, 0.4) 100%);
            box-shadow: 0 0 100px rgba(167, 139, 250, 0.6), inset 0 0 100px rgba(167, 139, 250, 0.2);
            filter: blur(14px);
        }

        .box.hold {
            width: 500px;
            height: 500px;
            background: linear-gradient(135deg, rgba(96, 165, 250, 0.35) 0%, rgba(59, 130, 246, 0.35) 100%);
            box-shadow: 0 0 90px rgba(96, 165, 250, 0.5), inset 0 0 90px rgba(96, 165, 250, 0.15);
            filter: blur(12px);
        }

        .box.breathe-out {
            width: 200px;
            height: 200px;
            background: linear-gradient(135deg, rgba(192, 132, 252, 0.35) 0%, rgba(168, 85, 247, 0.35) 100%);
            box-shadow: 0 0 70px rgba(192, 132, 252, 0.5), inset 0 0 70px rgba(192, 132, 252, 0.15);
            filter: blur(10px);
        }

        .instruction {
            font-size: 1.4em;
            margin-bottom: 16px;
            font-weight: 400;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            letter-spacing: 0.5px;
            opacity: 0.9;
        }

        .counter {
            font-size: 5em;
            font-weight: 300;
            margin-bottom: 0;
            background: linear-gradient(135deg, #a78bfa 0%, #c084fc 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -2px;
        }

        .controls {
            display: flex;
            gap: 12px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid rgba(255, 255, 255, 0.08);
        }

        button {
            padding: 12px 36px;
            font-size: 0.95em;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 500;
            letter-spacing: 0.5px;
            position: relative;
            overflow: hidden;
        }

        button::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        button:hover::before {
            width: 300px;
            height: 300px;
        }

        .start-btn {
            background: linear-gradient(135deg, #8b5cf6 0%, #a78bfa 100%);
            color: white;
            box-shadow: 0 4px 20px rgba(139, 92, 246, 0.4);
            position: relative;
            z-index: 1;
        }

        .start-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 30px rgba(139, 92, 246, 0.5);
        }

        .stop-btn {
            background: rgba(255, 255, 255, 0.08);
            color: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
            z-index: 1;
        }

        .stop-btn:hover {
            background: rgba(255, 255, 255, 0.12);
            transform: translateY(-2px);
        }

        button:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none;
        }

        button:disabled:hover {
            transform: none;
            box-shadow: none;
        }

        button:disabled::before {
            display: none;
        }

        .info {
            margin-top: 50px;
            font-size: 0.9em;
            opacity: 0.5;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            line-height: 1.6;
            font-weight: 300;
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 1.8em;
                margin-top: 70px;
            }

            .settings-icon {
                top: 12px;
                right: 12px;
                padding: 10px 16px;
                font-size: 0.9em;
            }

            .settings-label {
                font-size: 0.8em;
            }

            .settings-menu {
                top: 60px;
                right: 12px;
                width: calc(100vw - 24px);
                max-width: 320px;
            }
            
            .breathing-box {
                width: 400px;
                height: 400px;
            }

            .box {
                width: 260px;
                height: 260px;
            }

            .box.breathe-in {
                width: 380px;
                height: 380px;
            }

            .box.hold {
                width: 380px;
                height: 380px;
            }

            .box.breathe-out {
                width: 140px;
                height: 140px;
            }
            
            .counter {
                font-size: 4em;
            }

            .settings {
                padding: 16px 18px;
            }

            .settings h3 {
                font-size: 0.8em;
                margin-bottom: 10px;
            }

            .preset-btn {
                padding: 8px 12px;
                font-size: 0.8em;
            }

            button {
                padding: 10px 28px;
                font-size: 0.9em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <button class="settings-icon" onclick="toggleSettingsMenu()" aria-label="Audio Settings">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
            </svg>
            <span class="settings-label">Audio Settings</span>
        </button>

        <div class="settings-menu" id="settingsMenu">
            <div class="settings-menu-header">
                <h3>Audio Settings</h3>
                <button class="close-btn" onclick="toggleSettingsMenu()">Ã—</button>
            </div>
            <div class="settings-menu-content">
                <div class="toggle-group">
                    <label class="toggle-label">
                        <input type="checkbox" id="pingToggle" checked onchange="togglePing()">
                        <span class="toggle-slider"></span>
                        <span class="toggle-text">Transition Ping</span>
                    </label>
                </div>
                <div class="music-selection" id="pingSelection" style="margin-top: 16px; padding-top: 16px; border-top: 1px solid rgba(255, 255, 255, 0.08);">
                    <label class="selection-label">Ping Style:</label>
                    <select id="pingStyle" onchange="changePingStyle()">
                        <option value="medium">Medium (A3 - 220Hz)</option>
                        <option value="low">Low (A2 - 110Hz)</option>
                        <option value="high">High (A4 - 440Hz)</option>
                    </select>
                </div>
            </div>
        </div>

        <h1>Breathe with Me</h1>
        <p class="subtitle">Breathing Exercise for Calm & Focus</p>
        
        <div class="settings" id="settings">
            <h3>Breathing Pattern</h3>
            <div class="preset-buttons">
                <button class="preset-btn active" onclick="setPreset('box')">Box (4-4-4-4)</button>
                <button class="preset-btn" onclick="setPreset('relaxing')">Relaxing (4-7-8)</button>
                <button class="preset-btn" onclick="setPreset('energizing')">Energizing (4-4-6)</button>
            </div>
            <div class="custom-button-row">
                <button class="preset-btn" onclick="setPreset('custom')">Custom</button>
            </div>
            
            <div class="custom-controls" id="customControls" style="display: none;">
                <div class="slider-group">
                    <label>Breathe In: <span id="breatheInValue">4</span>s</label>
                    <input type="range" id="breatheInSlider" min="2" max="10" value="4" oninput="updateCustom()">
                </div>
                <div class="slider-group">
                    <label>Hold (After In): <span id="holdInValue">4</span>s</label>
                    <input type="range" id="holdInSlider" min="0" max="10" value="4" oninput="updateCustom()">
                </div>
                <div class="slider-group">
                    <label>Breathe Out: <span id="breatheOutValue">4</span>s</label>
                    <input type="range" id="breatheOutSlider" min="2" max="10" value="4" oninput="updateCustom()">
                </div>
                <div class="slider-group">
                    <label>Hold (After Out): <span id="holdOutValue">4</span>s</label>
                    <input type="range" id="holdOutSlider" min="0" max="10" value="4" oninput="updateCustom()">
                </div>
            </div>

            <div class="controls">
                <button class="start-btn" id="startBtn" onclick="startBreathing()">Start</button>
                <button class="stop-btn" id="stopBtn" onclick="stopBreathing()" disabled>Stop</button>
            </div>
        </div>
        
        <div class="instruction" id="instruction">Press Start to Begin</div>
        <div class="counter" id="counter">4</div>
        
        <div class="breathing-box">
            <div class="box" id="breathingBox"></div>
        </div>
        
        <div class="info">
            <p>Choose from preset patterns or create your own custom breathing rhythm. Toggle the transition ping sound and background music to customize your experience. Follow the visual cue and listen for the gentle ping to guide your breathing.</p>
        </div>
    </div>

    <script>
        let intervalId = null;
        let currentPhase = 0;
        let currentCount = 4;
        let audioContext = null;
        let currentPattern = 'box';
        let pingEnabled = true;
        let pingStyle = 'medium';
        
        let phases = [
            { name: 'Breathe In', class: 'breathe-in', duration: 4 },
            { name: 'Hold', class: 'hold', duration: 4 },
            { name: 'Breathe Out', class: 'breathe-out', duration: 4 },
            { name: 'Hold', class: 'hold', duration: 4 }
        ];

        // Ping style configurations
        const pingConfigs = {
            'medium': { frequency: 220, volume: 0.12, duration: 1.2 },  // A3 - Current
            'low': { frequency: 110, volume: 0.15, duration: 1.5 },     // A2 - Lower, slightly longer
            'high': { frequency: 440, volume: 0.08, duration: 1.0 }     // A4 - Higher, softer, shorter
        };

        function toggleSettingsMenu() {
            const menu = document.getElementById('settingsMenu');
            menu.classList.toggle('active');
        }

        // Close menu when clicking outside
        document.addEventListener('click', (e) => {
            const menu = document.getElementById('settingsMenu');
            const icon = document.querySelector('.settings-icon');
            if (menu.classList.contains('active') && 
                !menu.contains(e.target) && 
                !icon.contains(e.target)) {
                menu.classList.remove('active');
            }
        });

        function togglePing() {
            pingEnabled = document.getElementById('pingToggle').checked;
        }

        function changePingStyle() {
            pingStyle = document.getElementById('pingStyle').value;
        }

        function setPreset(pattern) {
            // Stop if currently running
            if (intervalId) {
                stopBreathing();
            }

            currentPattern = pattern;
            
            // Update active button
            document.querySelectorAll('.preset-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            // Set phases based on pattern
            switch(pattern) {
                case 'box':
                    phases = [
                        { name: 'Breathe In', class: 'breathe-in', duration: 4 },
                        { name: 'Hold', class: 'hold', duration: 4 },
                        { name: 'Breathe Out', class: 'breathe-out', duration: 4 },
                        { name: 'Hold', class: 'hold', duration: 4 }
                    ];
                    document.getElementById('customControls').style.display = 'none';
                    break;
                case 'relaxing':
                    phases = [
                        { name: 'Breathe In', class: 'breathe-in', duration: 4 },
                        { name: 'Hold', class: 'hold', duration: 7 },
                        { name: 'Breathe Out', class: 'breathe-out', duration: 8 },
                        { name: 'Hold', class: 'hold', duration: 0 }
                    ];
                    document.getElementById('customControls').style.display = 'none';
                    break;
                case 'energizing':
                    phases = [
                        { name: 'Breathe In', class: 'breathe-in', duration: 4 },
                        { name: 'Hold', class: 'hold', duration: 4 },
                        { name: 'Breathe Out', class: 'breathe-out', duration: 6 },
                        { name: 'Hold', class: 'hold', duration: 0 }
                    ];
                    document.getElementById('customControls').style.display = 'none';
                    break;
                case 'custom':
                    document.getElementById('customControls').style.display = 'block';
                    updateCustom();
                    break;
            }

            // Update counter display
            document.getElementById('counter').textContent = phases[0].duration;
        }

        function updateCustom() {
            const breatheIn = parseInt(document.getElementById('breatheInSlider').value);
            const holdIn = parseInt(document.getElementById('holdInSlider').value);
            const breatheOut = parseInt(document.getElementById('breatheOutSlider').value);
            const holdOut = parseInt(document.getElementById('holdOutSlider').value);

            document.getElementById('breatheInValue').textContent = breatheIn;
            document.getElementById('holdInValue').textContent = holdIn;
            document.getElementById('breatheOutValue').textContent = breatheOut;
            document.getElementById('holdOutValue').textContent = holdOut;

            phases = [
                { name: 'Breathe In', class: 'breathe-in', duration: breatheIn },
                { name: 'Hold', class: 'hold', duration: holdIn },
                { name: 'Breathe Out', class: 'breathe-out', duration: breatheOut },
                { name: 'Hold', class: 'hold', duration: holdOut }
            ];

            document.getElementById('counter').textContent = breatheIn;
        }

        // Create AudioContext for generating bell sound
        function initAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
        }

        // Generate a gentle ping sound for transitions
        function playBell() {
            if (!pingEnabled) return;
            
            initAudio();
            
            const now = audioContext.currentTime;
            const config = pingConfigs[pingStyle];
            
            // Create a single oscillator for a calming ping
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(config.frequency, now);
            
            // Soft volume with gentle fade based on ping style
            gainNode.gain.setValueAtTime(config.volume, now);
            gainNode.gain.exponentialRampToValueAtTime(0.001, now + config.duration);
            
            oscillator.start(now);
            oscillator.stop(now + config.duration);
        }

        function updateDisplay() {
            const phase = phases[currentPhase];
            document.getElementById('instruction').textContent = phase.name;
            document.getElementById('counter').textContent = currentCount;
        }

        function updatePhase() {
            const phase = phases[currentPhase];
            const box = document.getElementById('breathingBox');
            
            // For hold phases, don't change the class - just maintain current size
            if (phase.class === 'hold') {
                // Remove transition temporarily to prevent any movement
                box.style.transition = 'none';
                // Force a reflow to apply the no-transition immediately
                box.offsetHeight;
                return;
            }
            
            // Set transition duration to match the phase duration for breathe in/out
            box.style.transition = `all ${phase.duration}s cubic-bezier(0.4, 0, 0.2, 1)`;
            
            box.className = 'box ' + phase.class;
        }

        function startBreathing() {
            initAudio();
            
            // Reset to beginning
            currentPhase = 0;
            
            // Skip phases with 0 duration at start
            while (phases[currentPhase].duration === 0) {
                currentPhase = (currentPhase + 1) % phases.length;
            }
            
            currentCount = phases[currentPhase].duration;
            
            document.getElementById('startBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;
            
            updatePhase(); // Set the visual state for the phase
            updateDisplay(); // Update text displays
            playBell(); // Initial ping
            
            intervalId = setInterval(() => {
                currentCount--;
                
                if (currentCount === 0) {
                    // Move to next phase
                    currentPhase = (currentPhase + 1) % phases.length;
                    
                    // Skip phases with 0 duration
                    while (phases[currentPhase].duration === 0) {
                        currentPhase = (currentPhase + 1) % phases.length;
                    }
                    
                    currentCount = phases[currentPhase].duration;
                    updatePhase(); // Update the circle animation for new phase
                    playBell(); // Ping at phase transition
                }
                
                updateDisplay(); // Only update counter text
            }, 1000);
        }

        function stopBreathing() {
            if (intervalId) {
                clearInterval(intervalId);
                intervalId = null;
            }
            
            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            document.getElementById('instruction').textContent = 'Press Start to Begin';
            document.getElementById('counter').textContent = phases[0].duration;
            
            const box = document.getElementById('breathingBox');
            box.style.transition = 'all 1s cubic-bezier(0.4, 0, 0.2, 1)';
            box.className = 'box';
            
            // Stop music if it was playing
            if (musicEnabled) {
                stopBackgroundMusic();
                document.getElementById('musicToggle').checked = false;
                musicEnabled = false;
            }
        }

        // Handle page visibility to pause when tab is hidden
        document.addEventListener('visibilitychange', () => {
            if (document.hidden && intervalId) {
                stopBreathing();
            }
        });
    </script>
</body>
</html>