<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Box Breathing - Calm Your Mind</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', sans-serif;
            background: #0a0520;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #ffffff;
            overflow-x: hidden;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(ellipse at 20% 20%, rgba(99, 102, 241, 0.15) 0%, transparent 50%),
                        radial-gradient(ellipse at 80% 80%, rgba(139, 92, 246, 0.15) 0%, transparent 50%),
                        radial-gradient(ellipse at 50% 50%, rgba(59, 130, 246, 0.1) 0%, transparent 70%);
            z-index: 0;
        }

        /* Animated stars - more filled background with enhanced twinkling */
        body::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(2px 2px at 10% 20%, white, transparent),
                radial-gradient(2px 2px at 20% 30%, white, transparent),
                radial-gradient(2px 2px at 15% 45%, white, transparent),
                radial-gradient(1px 1px at 25% 15%, white, transparent),
                radial-gradient(2px 2px at 30% 60%, white, transparent),
                radial-gradient(1px 1px at 35% 35%, white, transparent),
                radial-gradient(2px 2px at 40% 75%, white, transparent),
                radial-gradient(1px 1px at 45% 50%, white, transparent),
                radial-gradient(2px 2px at 50% 10%, white, transparent),
                radial-gradient(1px 1px at 50% 50%, white, transparent),
                radial-gradient(2px 2px at 55% 85%, white, transparent),
                radial-gradient(1px 1px at 60% 25%, white, transparent),
                radial-gradient(2px 2px at 60% 70%, white, transparent),
                radial-gradient(1px 1px at 65% 45%, white, transparent),
                radial-gradient(2px 2px at 70% 55%, white, transparent),
                radial-gradient(1px 1px at 70% 35%, white, transparent),
                radial-gradient(2px 2px at 75% 20%, white, transparent),
                radial-gradient(1px 1px at 80% 10%, white, transparent),
                radial-gradient(2px 2px at 80% 65%, white, transparent),
                radial-gradient(1px 1px at 85% 40%, white, transparent),
                radial-gradient(2px 2px at 90% 60%, white, transparent),
                radial-gradient(1px 1px at 90% 80%, white, transparent),
                radial-gradient(2px 2px at 95% 30%, white, transparent),
                radial-gradient(1px 1px at 33% 80%, white, transparent),
                radial-gradient(1px 1px at 15% 75%, white, transparent),
                radial-gradient(1px 1px at 22% 55%, white, transparent),
                radial-gradient(1px 1px at 38% 92%, white, transparent),
                radial-gradient(1px 1px at 42% 5%, white, transparent),
                radial-gradient(1px 1px at 58% 68%, white, transparent),
                radial-gradient(1px 1px at 72% 88%, white, transparent),
                radial-gradient(1px 1px at 88% 15%, white, transparent),
                radial-gradient(1px 1px at 92% 45%, white, transparent),
                radial-gradient(1px 1px at 5% 60%, white, transparent),
                radial-gradient(1px 1px at 12% 10%, white, transparent),
                radial-gradient(1px 1px at 28% 38%, white, transparent),
                radial-gradient(1px 1px at 48% 82%, white, transparent),
                radial-gradient(1px 1px at 62% 58%, white, transparent),
                radial-gradient(1px 1px at 78% 72%, white, transparent),
                radial-gradient(1px 1px at 8% 35%, white, transparent),
                radial-gradient(1px 1px at 18% 65%, white, transparent),
                radial-gradient(2px 2px at 13% 52%, white, transparent),
                radial-gradient(1px 1px at 27% 88%, white, transparent),
                radial-gradient(2px 2px at 32% 12%, white, transparent),
                radial-gradient(1px 1px at 44% 28%, white, transparent),
                radial-gradient(2px 2px at 52% 95%, white, transparent),
                radial-gradient(1px 1px at 67% 18%, white, transparent),
                radial-gradient(2px 2px at 73% 42%, white, transparent),
                radial-gradient(1px 1px at 83% 78%, white, transparent),
                radial-gradient(2px 2px at 94% 52%, white, transparent),
                radial-gradient(1px 1px at 6% 22%, white, transparent),
                radial-gradient(2px 2px at 17% 38%, white, transparent),
                radial-gradient(1px 1px at 24% 72%, white, transparent),
                radial-gradient(2px 2px at 36% 48%, white, transparent),
                radial-gradient(1px 1px at 54% 33%, white, transparent),
                radial-gradient(2px 2px at 64% 82%, white, transparent),
                radial-gradient(1px 1px at 76% 8%, white, transparent),
                radial-gradient(2px 2px at 86% 62%, white, transparent),
                radial-gradient(1px 1px at 97% 15%, white, transparent);
            background-size: 100% 100%;
            background-position: 0% 0%;
            animation: twinkleStars 3s ease-in-out infinite;
            opacity: 0.8;
            z-index: 0;
            pointer-events: none;
        }

        @keyframes twinkleStars {
            0% { opacity: 0.8; }
            25% { opacity: 0.4; }
            50% { opacity: 0.9; }
            75% { opacity: 0.5; }
            100% { opacity: 0.8; }
        }

        .container {
            text-align: center;
            padding: 20px;
            position: relative;
            z-index: 1;
            max-width: 900px;
        }

        .settings-icon {
            position: fixed;
            top: 24px;
            right: 24px;
            padding: 12px 20px;
            border-radius: 50px;
            background: rgba(99, 102, 241, 0.15);
            border: 1px solid rgba(139, 92, 246, 0.3);
            backdrop-filter: blur(20px);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
            z-index: 1000;
            color: white;
            box-shadow: 0 4px 20px rgba(99, 102, 241, 0.2);
        }

        .settings-icon:hover {
            background: rgba(99, 102, 241, 0.25);
            border-color: rgba(139, 92, 246, 0.5);
            box-shadow: 0 6px 30px rgba(99, 102, 241, 0.4);
        }

        .settings-label {
            font-size: 0.9em;
            font-weight: 500;
            letter-spacing: 0.3px;
        }

        .settings-menu {
            position: fixed;
            top: 84px;
            right: 24px;
            width: 320px;
            background: rgba(10, 5, 32, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            border: 1px solid rgba(139, 92, 246, 0.3);
            box-shadow: 0 8px 32px rgba(99, 102, 241, 0.3);
            opacity: 0;
            transform: translateY(-10px);
            pointer-events: none;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 999;
        }

        .settings-menu.active {
            opacity: 1;
            transform: translateY(0);
            pointer-events: all;
        }

        .settings-menu-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px 16px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        }

        .settings-menu-header h3 {
            font-size: 1.1em;
            font-weight: 500;
            margin: 0;
        }

        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 2em;
            line-height: 1;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            transition: all 0.2s;
            opacity: 0.6;
        }

        .close-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            opacity: 1;
        }

        .settings-menu-content {
            padding: 20px 24px;
        }

        .music-selection {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid rgba(255, 255, 255, 0.08);
        }

        .selection-label {
            display: block;
            font-size: 0.9em;
            opacity: 0.7;
            margin-bottom: 8px;
        }

        select {
            width: 100%;
            padding: 10px 14px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            color: white;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.3s;
            outline: none;
        }

        select:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(255, 255, 255, 0.2);
        }

        select:focus {
            border-color: rgba(167, 139, 250, 0.5);
        }

        select option {
            background: #0a0520;
            color: white;
        }

        h1 {
            font-size: 2.2em;
            margin-bottom: 8px;
            font-weight: 600;
            letter-spacing: -0.5px;
            background: linear-gradient(135deg, #a78bfa 0%, #60a5fa 50%, #c084fc 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            font-size: 0.95em;
            margin-bottom: 35px;
            opacity: 0.6;
            font-weight: 400;
            letter-spacing: 0.3px;
        }

        .settings {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            padding: 28px 32px;
            margin: 0 auto 40px;
            max-width: 650px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .audio-settings {
            margin-bottom: 40px;
        }

        .audio-controls {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .toggle-group {
            display: flex;
            align-items: center;
            margin-bottom: 16px;
        }

        .toggle-group:last-of-type {
            margin-bottom: 0;
        }

        .toggle-label {
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            user-select: none;
            width: 100%;
        }

        .toggle-label input[type="checkbox"] {
            display: none;
        }

        .toggle-slider {
            position: relative;
            width: 44px;
            height: 24px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            transition: all 0.3s;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .toggle-slider::before {
            content: '';
            position: absolute;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.5);
            top: 2px;
            left: 3px;
            transition: all 0.3s;
        }

        .toggle-label input[type="checkbox"]:checked + .toggle-slider {
            background: linear-gradient(135deg, #8b5cf6 0%, #a78bfa 100%);
            border-color: transparent;
        }

        .toggle-label input[type="checkbox"]:checked + .toggle-slider::before {
            left: 21px;
            background: white;
        }

        .toggle-text {
            font-size: 0.9em;
            opacity: 0.8;
            font-weight: 400;
        }

        .settings h3 {
            margin-bottom: 18px;
            font-size: 0.95em;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            opacity: 0.7;
        }

        .preset-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 10px;
            margin-bottom: 10px;
        }

        .custom-button-row {
            display: flex;
            justify-content: center;
            margin-top: 10px;
        }

        .custom-button-row .preset-btn {
            min-width: 140px;
        }

        .preset-btn {
            padding: 12px 20px;
            font-size: 0.9em;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.05);
            color: rgba(255, 255, 255, 0.8);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 500;
            letter-spacing: 0.3px;
        }

        .preset-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
            color: white;
        }

        .preset-btn.active {
            background: linear-gradient(135deg, #8b5cf6 0%, #a78bfa 100%);
            border-color: transparent;
            color: white;
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);
        }

        .custom-controls {
            margin-top: 24px;
            padding-top: 24px;
            border-top: 1px solid rgba(255, 255, 255, 0.08);
        }

        .slider-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .slider-group label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 0.9em;
            opacity: 0.8;
            font-weight: 400;
        }

        .slider-group input[type="range"] {
            width: 100%;
            height: 4px;
            border-radius: 2px;
            background: rgba(255, 255, 255, 0.1);
            outline: none;
            -webkit-appearance: none;
        }

        .slider-group input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: linear-gradient(135deg, #a78bfa 0%, #c084fc 100%);
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(167, 139, 250, 0.5);
            transition: all 0.2s;
        }

        .slider-group input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.2);
        }

        .slider-group input[type="range"]::-moz-range-thumb {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: linear-gradient(135deg, #a78bfa 0%, #c084fc 100%);
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 8px rgba(167, 139, 250, 0.5);
        }

        .breathing-box {
            width: 450px;
            height: 450px;
            margin: 0 auto 50px;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .box {
            width: 280px;
            height: 280px;
            border: none;
            border-radius: 50%;
            position: absolute;
            transition: all 4s cubic-bezier(0.4, 0, 0.2, 1);
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            filter: blur(8px);
        }

        .box.breathe-in {
            width: 400px;
            height: 400px;
            background: linear-gradient(135deg, rgba(167, 139, 250, 0.4) 0%, rgba(139, 92, 246, 0.4) 100%);
            box-shadow: 0 0 80px rgba(167, 139, 250, 0.6), inset 0 0 80px rgba(167, 139, 250, 0.2);
            filter: blur(12px);
        }

        .box.hold {
            background: linear-gradient(135deg, rgba(96, 165, 250, 0.35) 0%, rgba(59, 130, 246, 0.35) 100%);
            box-shadow: 0 0 70px rgba(96, 165, 250, 0.5), inset 0 0 70px rgba(96, 165, 250, 0.15);
            filter: blur(10px);
        }

        .box.breathe-out {
            width: 160px;
            height: 160px;
            background: linear-gradient(135deg, rgba(192, 132, 252, 0.35) 0%, rgba(168, 85, 247, 0.35) 100%);
            box-shadow: 0 0 60px rgba(192, 132, 252, 0.5), inset 0 0 60px rgba(192, 132, 252, 0.15);
            filter: blur(8px);
        }

        .instruction {
            font-size: 1.4em;
            margin-bottom: 16px;
            font-weight: 400;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            letter-spacing: 0.5px;
            opacity: 0.9;
        }

        .counter {
            font-size: 5em;
            font-weight: 300;
            margin-bottom: 0;
            background: linear-gradient(135deg, #a78bfa 0%, #c084fc 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -2px;
        }

        .controls {
            display: flex;
            gap: 16px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 24px;
            padding-top: 24px;
            border-top: 1px solid rgba(255, 255, 255, 0.08);
        }

        button {
            padding: 16px 48px;
            font-size: 1em;
            border: none;
            border-radius: 14px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 500;
            letter-spacing: 0.5px;
            position: relative;
            overflow: hidden;
        }

        button::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        button:hover::before {
            width: 300px;
            height: 300px;
        }

        .start-btn {
            background: linear-gradient(135deg, #8b5cf6 0%, #a78bfa 100%);
            color: white;
            box-shadow: 0 4px 20px rgba(139, 92, 246, 0.4);
            position: relative;
            z-index: 1;
        }

        .start-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 30px rgba(139, 92, 246, 0.5);
        }

        .stop-btn {
            background: rgba(255, 255, 255, 0.08);
            color: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
            z-index: 1;
        }

        .stop-btn:hover {
            background: rgba(255, 255, 255, 0.12);
            transform: translateY(-2px);
        }

        button:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none;
        }

        button:disabled:hover {
            transform: none;
            box-shadow: none;
        }

        button:disabled::before {
            display: none;
        }

        .info {
            margin-top: 50px;
            font-size: 0.9em;
            opacity: 0.5;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            line-height: 1.6;
            font-weight: 300;
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 1.8em;
            }
            
            .breathing-box {
                width: 350px;
                height: 350px;
            }

            .box {
                width: 220px;
                height: 220px;
            }

            .box.breathe-in {
                width: 320px;
                height: 320px;
            }

            .box.breathe-out {
                width: 120px;
                height: 120px;
            }
            
            .counter {
                font-size: 4em;
            }

            .settings {
                padding: 24px 20px;
            }

            button {
                padding: 14px 36px;
                font-size: 0.95em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <button class="settings-icon" onclick="toggleSettingsMenu()" aria-label="Audio Settings">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
            </svg>
            <span class="settings-label">Audio Settings</span>
        </button>

        <div class="settings-menu" id="settingsMenu">
            <div class="settings-menu-header">
                <h3>Audio Settings</h3>
                <button class="close-btn" onclick="toggleSettingsMenu()">Ã—</button>
            </div>
            <div class="settings-menu-content">
                <div class="toggle-group">
                    <label class="toggle-label">
                        <input type="checkbox" id="pingToggle" checked onchange="togglePing()">
                        <span class="toggle-slider"></span>
                        <span class="toggle-text">Transition Ping</span>
                    </label>
                </div>
                <div class="music-selection" id="pingSelection" style="margin-top: 16px; padding-top: 16px; border-top: 1px solid rgba(255, 255, 255, 0.08);">
                    <label class="selection-label">Ping Style:</label>
                    <select id="pingStyle" onchange="changePingStyle()">
                        <option value="medium">Medium (A3 - 220Hz)</option>
                        <option value="low">Low (A2 - 110Hz)</option>
                        <option value="high">High (A4 - 440Hz)</option>
                    </select>
                </div>
                <div class="toggle-group" style="margin-top: 16px;">
                    <label class="toggle-label">
                        <input type="checkbox" id="musicToggle" onchange="toggleMusic()">
                        <span class="toggle-slider"></span>
                        <span class="toggle-text">Background Music</span>
                    </label>
                </div>
                <div class="music-selection" id="musicSelection" style="display: none;">
                    <label class="selection-label">Music Style:</label>
                    <select id="musicStyle" onchange="changeMusicStyle()">
                        <option value="moments-silence">Moments of Silence</option>
                        <option value="nature-ocean">Ocean Waves</option>
                        <option value="nature-thunderstorm">Thunderstorm</option>
                        <option value="nature-birds">Bird Songs</option>
                        <option value="white-noise">White Noise</option>
                    </select>
                </div>
            </div>
        </div>

        <h1>Breathe with Me</h1>
        <p class="subtitle">Breathing Exercise for Calm & Focus</p>
        
        <div class="settings" id="settings">
            <h3>Breathing Pattern</h3>
            <div class="preset-buttons">
                <button class="preset-btn active" onclick="setPreset('box')">Box (4-4-4-4)</button>
                <button class="preset-btn" onclick="setPreset('relaxing')">Relaxing (4-7-8)</button>
                <button class="preset-btn" onclick="setPreset('energizing')">Energizing (4-4-6)</button>
            </div>
            <div class="custom-button-row">
                <button class="preset-btn" onclick="setPreset('custom')">Custom</button>
            </div>
            
            <div class="custom-controls" id="customControls" style="display: none;">
                <div class="slider-group">
                    <label>Breathe In: <span id="breatheInValue">4</span>s</label>
                    <input type="range" id="breatheInSlider" min="2" max="10" value="4" oninput="updateCustom()">
                </div>
                <div class="slider-group">
                    <label>Hold (After In): <span id="holdInValue">4</span>s</label>
                    <input type="range" id="holdInSlider" min="0" max="10" value="4" oninput="updateCustom()">
                </div>
                <div class="slider-group">
                    <label>Breathe Out: <span id="breatheOutValue">4</span>s</label>
                    <input type="range" id="breatheOutSlider" min="2" max="10" value="4" oninput="updateCustom()">
                </div>
                <div class="slider-group">
                    <label>Hold (After Out): <span id="holdOutValue">4</span>s</label>
                    <input type="range" id="holdOutSlider" min="0" max="10" value="4" oninput="updateCustom()">
                </div>
            </div>

            <div class="controls">
                <button class="start-btn" id="startBtn" onclick="startBreathing()">Start</button>
                <button class="stop-btn" id="stopBtn" onclick="stopBreathing()" disabled>Stop</button>
            </div>
        </div>
        
        <div class="instruction" id="instruction">Press Start to Begin</div>
        <div class="counter" id="counter">4</div>
        
        <div class="breathing-box">
            <div class="box" id="breathingBox"></div>
        </div>
        
        <div class="info">
            <p>Choose from preset patterns or create your own custom breathing rhythm. Toggle the transition ping sound and background music to customize your experience. Follow the visual cue and listen for the gentle ping to guide your breathing.</p>
        </div>
    </div>

    <script>
        let intervalId = null;
        let currentPhase = 0;
        let currentCount = 4;
        let audioContext = null;
        let currentPattern = 'box';
        let pingEnabled = true;
        let pingStyle = 'medium';
        let musicEnabled = false;
        let musicNodes = null;
        let currentMusicStyle = 'moments-silence';
        let audioElement = null;
        
        let phases = [
            { name: 'Breathe In', class: 'breathe-in', duration: 4 },
            { name: 'Hold', class: 'hold', duration: 4 },
            { name: 'Breathe Out', class: 'breathe-out', duration: 4 },
            { name: 'Hold', class: 'hold', duration: 4 }
        ];

        // Ping style configurations
        const pingConfigs = {
            'medium': { frequency: 220, volume: 0.12, duration: 1.2 },  // A3 - Current
            'low': { frequency: 110, volume: 0.15, duration: 1.5 },     // A2 - Lower, slightly longer
            'high': { frequency: 440, volume: 0.08, duration: 1.0 }     // A4 - Higher, softer, shorter
        };

        // Royalty-free music URLs from free sources
        const musicLibrary = {
            'moments-silence': '../watermarked_Moments_Silence_Between_Stars_instrumental_2_45.mp3',
            'nature-ocean': 'https://cdn.pixabay.com/audio/2022/06/07/audio_89bb791e70.mp3',
            'nature-thunderstorm': 'https://cdn.pixabay.com/audio/2022/05/13/audio_257112ce5b.mp3',
            'nature-birds': 'https://cdn.pixabay.com/audio/2022/03/10/audio_4e573c5d8f.mp3'
        };

        function toggleSettingsMenu() {
            const menu = document.getElementById('settingsMenu');
            menu.classList.toggle('active');
        }

        // Close menu when clicking outside
        document.addEventListener('click', (e) => {
            const menu = document.getElementById('settingsMenu');
            const icon = document.querySelector('.settings-icon');
            if (menu.classList.contains('active') && 
                !menu.contains(e.target) && 
                !icon.contains(e.target)) {
                menu.classList.remove('active');
            }
        });

        function togglePing() {
            pingEnabled = document.getElementById('pingToggle').checked;
        }

        function changePingStyle() {
            pingStyle = document.getElementById('pingStyle').value;
        }

        function toggleMusic() {
            musicEnabled = document.getElementById('musicToggle').checked;
            const musicSelection = document.getElementById('musicSelection');
            
            if (musicEnabled) {
                musicSelection.style.display = 'block';
                startBackgroundMusic();
            } else {
                musicSelection.style.display = 'none';
                stopBackgroundMusic();
            }
        }

        function changeMusicStyle() {
            currentMusicStyle = document.getElementById('musicStyle').value;
            if (musicEnabled) {
                stopBackgroundMusic();
                startBackgroundMusic();
            }
        }

        function startBackgroundMusic() {
            if (musicNodes) {
                stopBackgroundMusic();
            }

            // Check if it's a nature sound that we'll synthesize more realistically
            if (currentMusicStyle.startsWith('nature-')) {
                initAudio();
                musicNodes = {};
                const now = audioContext.currentTime;
                createEnhancedNatureSound(now, currentMusicStyle);
            } else {
                // Try to load from the music library
                const musicUrl = musicLibrary[currentMusicStyle];
                if (musicUrl) {
                    if (!audioElement) {
                        audioElement = new Audio();
                        audioElement.loop = true;
                        audioElement.volume = 0.3;
                    }
                    audioElement.src = musicUrl;
                    audioElement.play().catch(err => {
                        console.log('Audio playback failed:', err);
                        // Fallback to synthesized sound
                        initAudio();
                        musicNodes = {};
                        createEnhancedNatureSound(audioContext.currentTime, 'nature-ocean');
                    });
                }
            }
        }

        function createEnhancedNatureSound(now, type) {
            musicNodes = {};
            
            switch(type) {
                case 'nature-ocean':
                    createOceanSound(now);
                    break;
                case 'nature-thunderstorm':
                    createThunderstormSound(now);
                    break;
                case 'nature-birds':
                    createBirdSound(now);
                    break;
                case 'white-noise':
                    createWhiteNoise(now);
                    break;
            }
        }

        function createWhiteNoise(now) {
            // Pure white noise - all frequencies equally
            const bufferSize = 2 * audioContext.sampleRate;
            const noiseBuffer = audioContext.createBuffer(1, bufferSize, audioContext.sampleRate);
            const output = noiseBuffer.getChannelData(0);
            
            for (let i = 0; i < bufferSize; i++) {
                output[i] = Math.random() * 2 - 1;
            }

            const noiseSource = audioContext.createBufferSource();
            noiseSource.buffer = noiseBuffer;
            noiseSource.loop = true;

            const noiseGain = audioContext.createGain();
            noiseGain.gain.setValueAtTime(0.15, now);

            noiseSource.connect(noiseGain);
            noiseGain.connect(audioContext.destination);
            noiseSource.start(now);

            musicNodes.baseOsc = noiseSource;
            musicNodes.baseGain = noiseGain;
            musicNodes.harmonics = [];
        }

        function createThunderstormSound(now) {
            // Heavy rain with pink noise
            const bufferSize = 2 * audioContext.sampleRate;
            const noiseBuffer = audioContext.createBuffer(1, bufferSize, audioContext.sampleRate);
            const output = noiseBuffer.getChannelData(0);
            
            let b0 = 0, b1 = 0, b2 = 0, b3 = 0, b4 = 0, b5 = 0, b6 = 0;
            for (let i = 0; i < bufferSize; i++) {
                const white = Math.random() * 2 - 1;
                b0 = 0.99886 * b0 + white * 0.0555179;
                b1 = 0.99332 * b1 + white * 0.0750759;
                b2 = 0.96900 * b2 + white * 0.1538520;
                b3 = 0.86650 * b3 + white * 0.3104856;
                b4 = 0.55000 * b4 + white * 0.5329522;
                b5 = -0.7616 * b5 - white * 0.0168980;
                output[i] = b0 + b1 + b2 + b3 + b4 + b5 + b6 + white * 0.5362;
                output[i] *= 0.11;
                b6 = white * 0.115926;
            }

            const rainSource = audioContext.createBufferSource();
            rainSource.buffer = noiseBuffer;
            rainSource.loop = true;

            const rainFilter = audioContext.createBiquadFilter();
            rainFilter.type = 'lowpass';
            rainFilter.frequency.setValueAtTime(1800, now);
            rainFilter.Q.setValueAtTime(0.5, now);

            const rainGain = audioContext.createGain();
            rainGain.gain.setValueAtTime(0.18, now);

            rainSource.connect(rainFilter);
            rainFilter.connect(rainGain);
            rainGain.connect(audioContext.destination);
            rainSource.start(now);

            musicNodes.baseOsc = rainSource;
            musicNodes.baseGain = rainGain;
            musicNodes.harmonics = [];

            // Add frequent thunder
            scheduleThunderstormThunder(now + 5);
        }

        function scheduleThunderstormThunder(time) {
            if (!musicEnabled || !musicNodes || currentMusicStyle !== 'nature-thunderstorm') return;

            const osc = audioContext.createOscillator();
            const gain = audioContext.createGain();
            const filter = audioContext.createBiquadFilter();

            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(35, time);
            osc.frequency.exponentialRampToValueAtTime(25, time + 3);

            filter.type = 'lowpass';
            filter.frequency.setValueAtTime(180, time);

            gain.gain.setValueAtTime(0, time);
            gain.gain.linearRampToValueAtTime(0.12, time + 0.6);
            gain.gain.exponentialRampToValueAtTime(0.001, time + 4);

            osc.connect(filter);
            filter.connect(gain);
            gain.connect(audioContext.destination);

            osc.start(time);
            osc.stop(time + 4);

            // More frequent thunder
            const nextTime = 8 + Math.random() * 15;
            setTimeout(() => {
                if (musicEnabled && musicNodes && currentMusicStyle === 'nature-thunderstorm') {
                    scheduleThunderstormThunder(audioContext.currentTime + 0.1);
                }
            }, nextTime * 1000);
        }

        function createBirdSound(now) {
            // Gentle ambient background
            const bufferSize = 2 * audioContext.sampleRate;
            const noiseBuffer = audioContext.createBuffer(1, bufferSize, audioContext.sampleRate);
            const output = noiseBuffer.getChannelData(0);
            for (let i = 0; i < bufferSize; i++) {
                output[i] = Math.random() * 2 - 1;
            }

            const ambientSource = audioContext.createBufferSource();
            ambientSource.buffer = noiseBuffer;
            ambientSource.loop = true;

            const ambientFilter = audioContext.createBiquadFilter();
            ambientFilter.type = 'bandpass';
            ambientFilter.frequency.setValueAtTime(500, now);
            ambientFilter.Q.setValueAtTime(0.8, now);

            const ambientGain = audioContext.createGain();
            ambientGain.gain.setValueAtTime(0.03, now);

            ambientSource.connect(ambientFilter);
            ambientFilter.connect(ambientGain);
            ambientGain.connect(audioContext.destination);
            ambientSource.start(now);

            musicNodes.baseOsc = ambientSource;
            musicNodes.baseGain = ambientGain;
            musicNodes.harmonics = [];

            // Add varied bird chirps
            scheduleBirdSong(now + 1);
        }

        function scheduleBirdSong(time) {
            if (!musicEnabled || !musicNodes || currentMusicStyle !== 'nature-birds') return;

            // Random bird type
            const birdType = Math.floor(Math.random() * 3);
            
            if (birdType === 0) {
                // Simple chirp
                const osc = audioContext.createOscillator();
                const gain = audioContext.createGain();

                osc.type = 'sine';
                const startFreq = 1400 + Math.random() * 600;
                osc.frequency.setValueAtTime(startFreq, time);
                osc.frequency.linearRampToValueAtTime(startFreq * 1.4, time + 0.08);

                gain.gain.setValueAtTime(0, time);
                gain.gain.linearRampToValueAtTime(0.06, time + 0.02);
                gain.gain.exponentialRampToValueAtTime(0.001, time + 0.12);

                osc.connect(gain);
                gain.connect(audioContext.destination);

                osc.start(time);
                osc.stop(time + 0.12);
            } else if (birdType === 1) {
                // Warble
                for (let i = 0; i < 3; i++) {
                    const osc = audioContext.createOscillator();
                    const gain = audioContext.createGain();
                    const startTime = time + (i * 0.15);

                    osc.type = 'sine';
                    const freq = 1600 + Math.random() * 400;
                    osc.frequency.setValueAtTime(freq, startTime);
                    osc.frequency.linearRampToValueAtTime(freq * 0.8, startTime + 0.1);

                    gain.gain.setValueAtTime(0, startTime);
                    gain.gain.linearRampToValueAtTime(0.05, startTime + 0.02);
                    gain.gain.exponentialRampToValueAtTime(0.001, startTime + 0.1);

                    osc.connect(gain);
                    gain.connect(audioContext.destination);

                    osc.start(startTime);
                    osc.stop(startTime + 0.1);
                }
            } else {
                // Descending call
                const osc = audioContext.createOscillator();
                const gain = audioContext.createGain();

                osc.type = 'sine';
                const startFreq = 2200 + Math.random() * 300;
                osc.frequency.setValueAtTime(startFreq, time);
                osc.frequency.exponentialRampToValueAtTime(startFreq * 0.6, time + 0.2);

                gain.gain.setValueAtTime(0, time);
                gain.gain.linearRampToValueAtTime(0.05, time + 0.03);
                gain.gain.exponentialRampToValueAtTime(0.001, time + 0.2);

                osc.connect(gain);
                gain.connect(audioContext.destination);

                osc.start(time);
                osc.stop(time + 0.2);
            }

            // Schedule next bird
            const nextDelay = 1.5 + Math.random() * 4;
            setTimeout(() => {
                if (musicEnabled && musicNodes && currentMusicStyle === 'nature-birds') {
                    scheduleBirdSong(audioContext.currentTime + 0.1);
                }
            }, nextDelay * 1000);
        }

        function createOceanSound(now) {
            // Ocean waves using filtered noise with LFO
            const bufferSize = 4 * audioContext.sampleRate;
            const noiseBuffer = audioContext.createBuffer(1, bufferSize, audioContext.sampleRate);
            const output = noiseBuffer.getChannelData(0);
            for (let i = 0; i < bufferSize; i++) {
                output[i] = Math.random() * 2 - 1;
            }

            const waveSource = audioContext.createBufferSource();
            waveSource.buffer = noiseBuffer;
            waveSource.loop = true;

            const waveFilter = audioContext.createBiquadFilter();
            waveFilter.type = 'lowpass';
            waveFilter.frequency.setValueAtTime(800, now);

            const waveGain = audioContext.createGain();
            
            // LFO for wave motion
            const lfo = audioContext.createOscillator();
            const lfoGain = audioContext.createGain();
            lfo.frequency.setValueAtTime(0.1, now); // Slow wave cycle
            lfoGain.gain.setValueAtTime(0.08, now);
            
            lfo.connect(lfoGain);
            lfoGain.connect(waveGain.gain);
            waveGain.gain.setValueAtTime(0.1, now);

            waveSource.connect(waveFilter);
            waveFilter.connect(waveGain);
            waveGain.connect(audioContext.destination);
            
            waveSource.start(now);
            lfo.start(now);

            musicNodes.baseOsc = waveSource;
            musicNodes.baseGain = waveGain;
            musicNodes.harmonics = [{ osc: lfo }];
        }

        function stopBackgroundMusic() {
            // Stop HTML audio element if playing
            if (audioElement) {
                audioElement.pause();
                audioElement.currentTime = 0;
            }

            // Stop synthesized audio nodes
            if (!musicNodes) return;
            
            const now = audioContext.currentTime;
            
            // Fade out all nodes
            if (musicNodes.baseGain) {
                musicNodes.baseGain.gain.linearRampToValueAtTime(0, now + 0.5);
            }
            if (musicNodes.baseOsc) {
                try {
                    musicNodes.baseOsc.stop(now + 0.5);
                } catch(e) {
                    // Already stopped
                }
            }
            
            if (musicNodes.harmonics) {
                musicNodes.harmonics.forEach((node) => {
                    if (node.gain) {
                        node.gain.gain.linearRampToValueAtTime(0, now + 0.5);
                    }
                    if (node.osc) {
                        try {
                            node.osc.stop(now + 0.5);
                        } catch(e) {
                            // Already stopped
                        }
                    }
                    if (node.detune) {
                        try {
                            node.detune.stop(now + 0.5);
                        } catch(e) {
                            // Already stopped
                        }
                    }
                });
            }
            
            musicNodes = null;
        }

        function setPreset(pattern) {
            // Stop if currently running
            if (intervalId) {
                stopBreathing();
            }

            currentPattern = pattern;
            
            // Update active button
            document.querySelectorAll('.preset-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            // Set phases based on pattern
            switch(pattern) {
                case 'box':
                    phases = [
                        { name: 'Breathe In', class: 'breathe-in', duration: 4 },
                        { name: 'Hold', class: 'hold', duration: 4 },
                        { name: 'Breathe Out', class: 'breathe-out', duration: 4 },
                        { name: 'Hold', class: 'hold', duration: 4 }
                    ];
                    document.getElementById('customControls').style.display = 'none';
                    break;
                case 'relaxing':
                    phases = [
                        { name: 'Breathe In', class: 'breathe-in', duration: 4 },
                        { name: 'Hold', class: 'hold', duration: 7 },
                        { name: 'Breathe Out', class: 'breathe-out', duration: 8 },
                        { name: 'Hold', class: 'hold', duration: 0 }
                    ];
                    document.getElementById('customControls').style.display = 'none';
                    break;
                case 'energizing':
                    phases = [
                        { name: 'Breathe In', class: 'breathe-in', duration: 4 },
                        { name: 'Hold', class: 'hold', duration: 4 },
                        { name: 'Breathe Out', class: 'breathe-out', duration: 6 },
                        { name: 'Hold', class: 'hold', duration: 0 }
                    ];
                    document.getElementById('customControls').style.display = 'none';
                    break;
                case 'custom':
                    document.getElementById('customControls').style.display = 'block';
                    updateCustom();
                    break;
            }

            // Update counter display
            document.getElementById('counter').textContent = phases[0].duration;
        }

        function updateCustom() {
            const breatheIn = parseInt(document.getElementById('breatheInSlider').value);
            const holdIn = parseInt(document.getElementById('holdInSlider').value);
            const breatheOut = parseInt(document.getElementById('breatheOutSlider').value);
            const holdOut = parseInt(document.getElementById('holdOutSlider').value);

            document.getElementById('breatheInValue').textContent = breatheIn;
            document.getElementById('holdInValue').textContent = holdIn;
            document.getElementById('breatheOutValue').textContent = breatheOut;
            document.getElementById('holdOutValue').textContent = holdOut;

            phases = [
                { name: 'Breathe In', class: 'breathe-in', duration: breatheIn },
                { name: 'Hold', class: 'hold', duration: holdIn },
                { name: 'Breathe Out', class: 'breathe-out', duration: breatheOut },
                { name: 'Hold', class: 'hold', duration: holdOut }
            ];

            document.getElementById('counter').textContent = breatheIn;
        }

        // Create AudioContext for generating bell sound
        function initAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
        }

        // Generate a gentle ping sound for transitions
        function playBell() {
            if (!pingEnabled) return;
            
            initAudio();
            
            const now = audioContext.currentTime;
            const config = pingConfigs[pingStyle];
            
            // Create a single oscillator for a calming ping
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(config.frequency, now);
            
            // Soft volume with gentle fade based on ping style
            gainNode.gain.setValueAtTime(config.volume, now);
            gainNode.gain.exponentialRampToValueAtTime(0.001, now + config.duration);
            
            oscillator.start(now);
            oscillator.stop(now + config.duration);
        }

        function updateDisplay() {
            const phase = phases[currentPhase];
            document.getElementById('instruction').textContent = phase.name;
            document.getElementById('counter').textContent = currentCount;
            
            const box = document.getElementById('breathingBox');
            box.className = 'box ' + phase.class;
        }

        function startBreathing() {
            initAudio();
            
            // Reset to beginning
            currentPhase = 0;
            
            // Skip phases with 0 duration at start
            while (phases[currentPhase].duration === 0) {
                currentPhase = (currentPhase + 1) % phases.length;
            }
            
            currentCount = phases[currentPhase].duration;
            
            document.getElementById('startBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;
            
            updateDisplay();
            playBell(); // Initial ping
            
            intervalId = setInterval(() => {
                currentCount--;
                
                if (currentCount === 0) {
                    // Move to next phase
                    currentPhase = (currentPhase + 1) % phases.length;
                    
                    // Skip phases with 0 duration
                    while (phases[currentPhase].duration === 0) {
                        currentPhase = (currentPhase + 1) % phases.length;
                    }
                    
                    currentCount = phases[currentPhase].duration;
                    playBell(); // Ping at phase transition
                }
                
                updateDisplay();
            }, 1000);
        }

        function stopBreathing() {
            if (intervalId) {
                clearInterval(intervalId);
                intervalId = null;
            }
            
            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            document.getElementById('instruction').textContent = 'Press Start to Begin';
            document.getElementById('counter').textContent = phases[0].duration;
            
            const box = document.getElementById('breathingBox');
            box.className = 'box';
            
            // Stop music if it was playing
            if (musicEnabled) {
                stopBackgroundMusic();
                document.getElementById('musicToggle').checked = false;
                musicEnabled = false;
            }
        }

        // Handle page visibility to pause when tab is hidden
        document.addEventListener('visibilitychange', () => {
            if (document.hidden && intervalId) {
                stopBreathing();
            }
        });
    </script>
</body>
</html>